{% extends "base.html" %}
{% block title %}Dashboard - Calendar Aggregator{% endblock %}
{% block content %}
{% if message %}
<div class="alert alert-success">{{ message }}</div>
{% endif %}

<div class="card">
    <h2>Subscription URLs</h2>
    <p class="text-muted mb-4">Use these URLs to subscribe to your unified calendar from other calendar apps.</p>
    
    <div class="form-group">
        <label>ICS/Webcal Feed URL:</label>
        <div class="url-box">
            <code id="ics-url">{{ ics_url }}</code>
            <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ ics_url }}')">Copy</button>
        </div>
    </div>
    
    <div class="form-group">
        <label>Webcal Protocol URL (for one-click subscribe):</label>
        <div class="url-box">
            <code id="webcal-url">{{ webcal_url }}</code>
            <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ webcal_url }}')">Copy</button>
        </div>
    </div>
    
    <p class="text-small text-muted mt-4">
        <strong>Tip:</strong> Most calendar apps (Google Calendar, Apple Calendar, Outlook) support subscribing 
        via the ICS URL. Look for "Subscribe to calendar" or "Add by URL" option.
    </p>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">Calendar Sources</h2>
        <div class="actions">
            <form action="/sync-all" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-success">Sync All</button>
            </form>
            <a href="/sources/add" class="btn btn-primary">Add Source</a>
        </div>
    </div>
    
    {% if sources %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Masking</th>
                <th>Last Sync</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for source in sources %}
            <tr>
                <td>{{ source.name }}</td>
                <td>{{ source.source_type.value }}</td>
                <td>
                    {% if source.masking %}
                    <span class="badge badge-warning">ON</span>
                    {% else %}
                    <span class="badge badge-info">OFF</span>
                    {% endif %}
                </td>
                <td class="text-small">
                    {% if source.last_sync_at %}
                    {{ source.last_sync_at.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                    Never
                    {% endif %}
                </td>
                <td>
                    {% if source.last_sync_status == 'success' %}
                    <span class="badge badge-success">Success</span>
                    {% elif source.last_sync_status == 'error' %}
                    <span class="badge badge-danger" title="{{ source.last_sync_error }}">Error</span>
                    {% else %}
                    <span class="badge badge-info">Pending</span>
                    {% endif %}
                </td>
                <td class="actions">
                    <form action="/sources/{{ source.id }}/sync" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-success">Sync</button>
                    </form>
                    <a href="/sources/{{ source.id }}/edit" class="btn btn-sm btn-secondary">Edit</a>
                    <form action="/sources/{{ source.id }}/delete" method="POST" style="display: inline;" 
                          onsubmit="return confirm('Are you sure you want to delete this source?');">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No calendar sources configured yet. <a href="/sources/add">Add your first source</a>.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Upcoming Events Preview</h2>
    <p class="text-muted mb-4">Shows next 10 events as they will appear in the published calendar (with masking applied).</p>
    
    {% if events %}
    {% for event in events[:10] %}
    <div class="event-item {% if event.is_masked %}masked{% endif %}">
        <div class="event-time">
            {% if event.is_all_day %}
            {{ event.start.strftime('%Y-%m-%d') }} (All day)
            {% else %}
            {{ event.start.strftime('%Y-%m-%d %H:%M') }} - {{ event.end.strftime('%H:%M') }}
            {% endif %}
        </div>
        <div class="event-title">{{ event.summary }}</div>
        {% if event.location %}
        <div class="text-small text-muted">{{ event.location }}</div>
        {% endif %}
        <div class="event-source">Source: {{ event.source_name }} {% if event.is_masked %}<span class="badge badge-warning">Masked</span>{% endif %}</div>
    </div>
    {% endfor %}
    {% if events|length > 10 %}
    <p class="text-muted mt-4"><a href="/preview">View all {{ events|length }} events</a></p>
    {% endif %}
    {% else %}
    <p class="text-muted">No upcoming events. Sync your calendar sources to see events here.</p>
    {% endif %}
</div>
{% endblock %}
